name: "Test: Notebook Execution"

on:
  workflow_call: {}

jobs:
  test-notebooks:
    runs-on: ubuntu-latest
    strategy:
        fail-fast: false
        matrix:
            notebook:
                - learn/search/semantic-search/semantic-search.ipynb
                # - docs/gen-qa-openai.ipynb
                - docs/langchain-retrieval-agent.ipynb
                - docs/langchain-retrieval-augmentation.ipynb
                - docs/pinecone-reranker.ipynb
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install nbformat

      - id: convert
        name: Convest test notebook into tmpdir script
        run: |
          python .github/scripts/convert-notebook.py ${{ matrix.notebook }}
    
      - name: View setup script notebook content
        shell: bash
        run: |
          cat ${{ steps.convert.outputs.script_path }}

      - name: View converted notebook content
        shell: bash
        run: |
          cat ${{ steps.convert.outputs.notebook_path }}

      - name: Run the converted notebook
        shell: bash
        run: |
          bash ${{ steps.convert.outputs.script_path }}
        env:
            PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
            OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
